<!DOCTYPE html>
<html lang="en">

<head>
  

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>

<link rel="shortcut icon" type="image/png" href="/favicon.ico"/>


<link rel='stylesheet' href='/style.min.6f047efea46ea2384fb98ee2d90642926037234cfeb77e270bbd5421bb705db6.css'>


<script src='/main.min.0b774fda2366fc06803dd619b7467da11181c73a4ef394b7610a2eb2a3cb7b5d.js' async></script>


  <title>Proxying object storage through nginx - Mastodon documentation</title>

  <meta property="og:type" content="article">
  <meta property="og:url" content="https://docs.joinmastodon.org/admin/optional/object-storage-proxy/">

  
    <meta name="description" content="Serving user-uploaded files in Mastodon from your own domain">
    <meta property="og:description" content="Serving user-uploaded files in Mastodon from your own domain">
    <meta name="twitter:description" content="Serving user-uploaded files in Mastodon from your own domain">
  

  <meta name="twitter:title" content="Proxying object storage through nginx">
  <meta name="twitter:site" content="@joinmastodon">

  <link rel="canonical" href="https://docs.joinmastodon.org/admin/optional/object-storage-proxy/">
</head>

<body>
  <div class="container sidebar-layout">
    <nav class="sidebar"><a class="brand" href="/">
  <img class="link-logo" src="/brand.svg" alt="Mastodon" />
</a>

<input id="mobile-nav-toggle" class="mobile-nav-toggle" type="checkbox">
<label for="mobile-nav-toggle">
    <span class="menu-open">
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M6.4 19L5 17.6l5.6-5.6L5 6.4L6.4 5l5.6 5.6L17.6 5L19 6.4L13.4 12l5.6 5.6l-1.4 1.4l-5.6-5.6z"/></svg>
    </span>
    <span class="menu-close">
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M3 18v-2h18v2zm0-5v-2h18v2zm0-5V6h18v2z"/></svg>
    </span>
</label>

<ul>
  
  
    <li>
      
        <a href="/" class="">What is Mastodon?</a>
      

      
    </li>
  
    <li>
      
        <span class="sub-title">Using Mastodon</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/user/signup/" class="">Signing up for an account</a>

              
            </li>
          
            <li>
              <a href="/user/profile/" class="">Setting up your profile</a>

              
            </li>
          
            <li>
              <a href="/user/posting/" class="">Posting to your profile</a>

              
            </li>
          
            <li>
              <a href="/user/network/" class="">Using the network features</a>

              
            </li>
          
            <li>
              <a href="/user/moderating/" class="">Dealing with unwanted content</a>

              
            </li>
          
            <li>
              <a href="/user/discoverability/" class="">Promoting yourself and others</a>

              
            </li>
          
            <li>
              <a href="/user/preferences/" class="">Set your preferences</a>

              
            </li>
          
            <li>
              <a href="/user/contacts/" class="">More settings</a>

              
            </li>
          
            <li>
              <a href="/user/external/" class="">Using Mastodon externally</a>

              
            </li>
          
            <li>
              <a href="/user/moving/" class="">Moving or leaving accounts</a>

              
            </li>
          
            <li>
              <a href="/user/run-your-own/" class="">Running your own server</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">Running Mastodon</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/admin/prerequisites/" class="">Preparing your machine</a>

              
            </li>
          
            <li>
              <a href="/admin/install/" class="">Installing from source</a>

              
            </li>
          
            <li>
              <a href="/admin/config/" class="">Configuring your environment</a>

              
            </li>
          
            <li>
              <a href="/admin/elasticsearch/" class="">Configuring full-text search</a>

              
            </li>
          
            <li>
              <a href="/admin/optional/" class="">Installing optional features</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/admin/optional/object-storage/" class="">Object storage</a>
                    </li>
                  
                    <li>
                      <a href="/admin/optional/tor/" class="">Onion services</a>
                    </li>
                  
                    <li>
                      <a href="/admin/optional/captcha/" class="">Captcha</a>
                    </li>
                  
                    <li>
                      <a href="/admin/optional/sso/" class="">Single Sign On</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/admin/setup/" class="">Setting up your new instance</a>

              
            </li>
          
            <li>
              <a href="/admin/tootctl/" class="">Using the admin CLI</a>

              
            </li>
          
            <li>
              <a href="/admin/upgrading/" class="">Upgrading to a new release</a>

              
            </li>
          
            <li>
              <a href="/admin/backups/" class="">Backing up your server</a>

              
            </li>
          
            <li>
              <a href="/admin/migrating/" class="">Migrating to a new machine</a>

              
            </li>
          
            <li>
              <a href="/admin/scaling/" class="">Scaling up your server</a>

              
            </li>
          
            <li>
              <a href="/admin/moderation/" class="">Moderation actions</a>

              
            </li>
          
            <li>
              <a href="/admin/troubleshooting/" class="">Troubleshooting errors</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/admin/troubleshooting/index-corruption/" class="">Database index corruption</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/admin/roles/" class="">Roles</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">Developing Mastodon apps</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/client/intro/" class="">Getting started with the API</a>

              
            </li>
          
            <li>
              <a href="/client/public/" class="">Playing with public data</a>

              
            </li>
          
            <li>
              <a href="/client/token/" class="">Obtaining client app access</a>

              
            </li>
          
            <li>
              <a href="/client/authorized/" class="">Logging in with an account</a>

              
            </li>
          
            <li>
              <a href="/client/libraries/" class="">Libraries and implementations</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">Contributing to Mastodon</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/dev/overview/" class="">Technical overview</a>

              
            </li>
          
            <li>
              <a href="/dev/setup/" class="">Setting up a dev environment</a>

              
            </li>
          
            <li>
              <a href="/dev/code/" class="">Code structure</a>

              
            </li>
          
            <li>
              <a href="/dev/routes/" class="">Routes</a>

              
            </li>
          
            <li>
              <a href="/dev/disclosure/" class="">Bug bounties and responsible disclosure</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">Spec compliance</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/spec/activitypub/" class="">ActivityPub</a>

              
            </li>
          
            <li>
              <a href="/spec/webfinger/" class="">WebFinger</a>

              
            </li>
          
            <li>
              <a href="/spec/security/" class="">Security</a>

              
            </li>
          
            <li>
              <a href="/spec/microformats/" class="">Microformats</a>

              
            </li>
          
            <li>
              <a href="/spec/oauth/" class="">OAuth</a>

              
            </li>
          
            <li>
              <a href="/spec/bearcaps/" class="">Bearcaps</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">REST API</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/api/guidelines/" class="">Guidelines and best practices</a>

              
            </li>
          
            <li>
              <a href="/api/oauth-scopes/" class="">OAuth Scopes</a>

              
            </li>
          
            <li>
              <a href="/api/rate-limits/" class="">Rate limits</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">API Methods</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/methods/apps/" class="">apps</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/oauth/" class="">oauth</a>
                    </li>
                  
                    <li>
                      <a href="/methods/emails/" class="">emails</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/accounts/" class="">accounts</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/bookmarks/" class="">bookmarks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/favourites/" class="">favourites</a>
                    </li>
                  
                    <li>
                      <a href="/methods/mutes/" class="">mutes</a>
                    </li>
                  
                    <li>
                      <a href="/methods/blocks/" class="">blocks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/domain_blocks/" class="">domain_blocks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/filters/" class="">filters</a>
                    </li>
                  
                    <li>
                      <a href="/methods/reports/" class="">reports</a>
                    </li>
                  
                    <li>
                      <a href="/methods/follow_requests/" class="">follow_requests</a>
                    </li>
                  
                    <li>
                      <a href="/methods/endorsements/" class="">endorsements</a>
                    </li>
                  
                    <li>
                      <a href="/methods/featured_tags/" class="">featured_tags</a>
                    </li>
                  
                    <li>
                      <a href="/methods/preferences/" class="">preferences</a>
                    </li>
                  
                    <li>
                      <a href="/methods/followed_tags/" class="">followed_tags</a>
                    </li>
                  
                    <li>
                      <a href="/methods/suggestions/" class="">suggestions</a>
                    </li>
                  
                    <li>
                      <a href="/methods/tags/" class="">tags</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/profile/" class="">profile</a>

              
            </li>
          
            <li>
              <a href="/methods/statuses/" class="">statuses</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/media/" class="">media</a>
                    </li>
                  
                    <li>
                      <a href="/methods/polls/" class="">polls</a>
                    </li>
                  
                    <li>
                      <a href="/methods/scheduled_statuses/" class="">scheduled_statuses</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/timelines/" class="">timelines</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/conversations/" class="">conversations</a>
                    </li>
                  
                    <li>
                      <a href="/methods/lists/" class="">lists</a>
                    </li>
                  
                    <li>
                      <a href="/methods/markers/" class="">markers</a>
                    </li>
                  
                    <li>
                      <a href="/methods/streaming/" class="">streaming</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/notifications/" class="">notifications</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/push/" class="">push</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/search/" class="">search</a>

              
            </li>
          
            <li>
              <a href="/methods/instance/" class="">instance</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/trends/" class="">trends</a>
                    </li>
                  
                    <li>
                      <a href="/methods/directory/" class="">directory</a>
                    </li>
                  
                    <li>
                      <a href="/methods/custom_emojis/" class="">custom_emojis</a>
                    </li>
                  
                    <li>
                      <a href="/methods/announcements/" class="">announcements</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/admin/" class="">admin</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/admin/accounts/" class="">accounts</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/canonical_email_blocks/" class="">canonical_email_blocks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/dimensions/" class="">dimensions</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/domain_allows/" class="">domain_allows</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/domain_blocks/" class="">domain_blocks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/email_domain_blocks/" class="">email_domain_blocks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/ip_blocks/" class="">ip_blocks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/measures/" class="">measures</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/reports/" class="">reports</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/retention/" class="">retention</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/trends/" class="">trends</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/proofs/" class="">proofs</a>

              
            </li>
          
            <li>
              <a href="/methods/oembed/" class="">oembed</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">API Entities</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/entities/Account/" class="">Account</a>

              
            </li>
          
            <li>
              <a href="/entities/AccountWarning/" class="">AccountWarning</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_Account/" class="">Admin::Account</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_CanonicalEmailBlock/" class="">Admin::CanonicalEmailBlock</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_Cohort/" class="">Admin::Cohort</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_Dimension/" class="">Admin::Dimension</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_DomainAllow/" class="">Admin::DomainAllow</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_DomainBlock/" class="">Admin::DomainBlock</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_EmailDomainBlock/" class="">Admin::EmailDomainBlock</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_Ip/" class="">Admin::Ip</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_IpBlock/" class="">Admin::IpBlock</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_Measure/" class="">Admin::Measure</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_Report/" class="">Admin::Report</a>

              
            </li>
          
            <li>
              <a href="/entities/Announcement/" class="">Announcement</a>

              
            </li>
          
            <li>
              <a href="/entities/Appeal/" class="">Appeal</a>

              
            </li>
          
            <li>
              <a href="/entities/Application/" class="">Application</a>

              
            </li>
          
            <li>
              <a href="/entities/Context/" class="">Context</a>

              
            </li>
          
            <li>
              <a href="/entities/Conversation/" class="">Conversation</a>

              
            </li>
          
            <li>
              <a href="/entities/CustomEmoji/" class="">CustomEmoji</a>

              
            </li>
          
            <li>
              <a href="/entities/DomainBlock/" class="">DomainBlock</a>

              
            </li>
          
            <li>
              <a href="/entities/Error/" class="">Error</a>

              
            </li>
          
            <li>
              <a href="/entities/ExtendedDescription/" class="">ExtendedDescription</a>

              
            </li>
          
            <li>
              <a href="/entities/FamiliarFollowers/" class="">FamiliarFollowers</a>

              
            </li>
          
            <li>
              <a href="/entities/FeaturedTag/" class="">FeaturedTag</a>

              
            </li>
          
            <li>
              <a href="/entities/Filter/" class="">Filter</a>

              
            </li>
          
            <li>
              <a href="/entities/FilterKeyword/" class="">FilterKeyword</a>

              
            </li>
          
            <li>
              <a href="/entities/FilterResult/" class="">FilterResult</a>

              
            </li>
          
            <li>
              <a href="/entities/FilterStatus/" class="">FilterStatus</a>

              
            </li>
          
            <li>
              <a href="/entities/IdentityProof/" class="">IdentityProof</a>

              
            </li>
          
            <li>
              <a href="/entities/Instance/" class="">Instance</a>

              
            </li>
          
            <li>
              <a href="/entities/List/" class="">List</a>

              
            </li>
          
            <li>
              <a href="/entities/Marker/" class="">Marker</a>

              
            </li>
          
            <li>
              <a href="/entities/MediaAttachment/" class="">MediaAttachment</a>

              
            </li>
          
            <li>
              <a href="/entities/Notification/" class="">Notification</a>

              
            </li>
          
            <li>
              <a href="/entities/NotificationPolicy/" class="">NotificationPolicy</a>

              
            </li>
          
            <li>
              <a href="/entities/NotificationRequest/" class="">NotificationRequest</a>

              
            </li>
          
            <li>
              <a href="/entities/Poll/" class="">Poll</a>

              
            </li>
          
            <li>
              <a href="/entities/Preferences/" class="">Preferences</a>

              
            </li>
          
            <li>
              <a href="/entities/PreviewCard/" class="">PreviewCard</a>

              
            </li>
          
            <li>
              <a href="/entities/PreviewCardAuthor/" class="">PreviewCardAuthor</a>

              
            </li>
          
            <li>
              <a href="/entities/Reaction/" class="">Reaction</a>

              
            </li>
          
            <li>
              <a href="/entities/Relationship/" class="">Relationship</a>

              
            </li>
          
            <li>
              <a href="/entities/RelationshipSeveranceEvent/" class="">RelationshipSeveranceEvent</a>

              
            </li>
          
            <li>
              <a href="/entities/Report/" class="">Report</a>

              
            </li>
          
            <li>
              <a href="/entities/Role/" class="">Role</a>

              
            </li>
          
            <li>
              <a href="/entities/Rule/" class="">Rule</a>

              
            </li>
          
            <li>
              <a href="/entities/ScheduledStatus/" class="">ScheduledStatus</a>

              
            </li>
          
            <li>
              <a href="/entities/Search/" class="">Search</a>

              
            </li>
          
            <li>
              <a href="/entities/Status/" class="">Status</a>

              
            </li>
          
            <li>
              <a href="/entities/StatusEdit/" class="">StatusEdit</a>

              
            </li>
          
            <li>
              <a href="/entities/StatusSource/" class="">StatusSource</a>

              
            </li>
          
            <li>
              <a href="/entities/Suggestion/" class="">Suggestion</a>

              
            </li>
          
            <li>
              <a href="/entities/Tag/" class="">Tag</a>

              
            </li>
          
            <li>
              <a href="/entities/Token/" class="">Token</a>

              
            </li>
          
            <li>
              <a href="/entities/Translation/" class="">Translation</a>

              
            </li>
          
            <li>
              <a href="/entities/V1_Filter/" class="">V1::Filter</a>

              
            </li>
          
            <li>
              <a href="/entities/V1_Instance/" class="">V1::Instance</a>

              
            </li>
          
            <li>
              <a href="/entities/V1_NotificationPolicy/" class="">V1::NotificationPolicy</a>

              
            </li>
          
            <li>
              <a href="/entities/WebPushSubscription/" class="">WebPushSubscription</a>

              
            </li>
          
        </ul>
      
    </li>
  
</ul>
</nav>
    <main>
  <h1>Proxying object storage through nginx</h1>

  
    <p>Serving user-uploaded files in Mastodon from your own domain</p>
  
  <aside>
    <nav id="TableOfContents"></nav>
  </aside>
  <div class="e-content">
    <p>When you are using Mastodon with an object storage provider like Amazon S3, Wasabi, Google Cloud or others, by default the URLs of the files go through the storage providers themselves. This has the following downsides:</p>
<ul>
<li>Bandwidth is usually metered and very expensive</li>
<li>URLs will be broken if you decide to switch providers later</li>
</ul>
<p>You can choose to serve the files from your own domain, incorporating caching in the process. In Mastodon, access patterns show that new files are often simultaneously accessed by many clients as they appear in new posts via the streaming API or are shared through federation; in contrast, older content is accessed less frequently. Therefore, relying solely on caching won&rsquo;t significantly reduce the bandwidth usage of your proxy from the actual object storage. To address this, we can implement a cache lock mechanism, which ensures that only one proxy request is made at a time.</p>
<p>Here is an example nginx configuration that accomplishes this:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#ff7b72">server</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">listen</span> <span style="color:#a5d6ff">443</span> <span style="color:#a5d6ff">ssl</span> <span style="color:#a5d6ff">http2</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">listen</span> <span style="color:#a5d6ff">[::]:443</span> <span style="color:#a5d6ff">ssl</span> <span style="color:#a5d6ff">http2</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">server_name</span> <span style="color:#a5d6ff">files.example.com</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">root</span> <span style="color:#a5d6ff">/var/www/html</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">ssl_certificate</span>     <span style="color:#a5d6ff">/etc/ssl/certs/ssl-cert-snakeoil.pem</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">ssl_certificate_key</span> <span style="color:#a5d6ff">/etc/ssl/private/ssl-cert-snakeoil.key</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">keepalive_timeout</span> <span style="color:#a5d6ff">30</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">location</span> = <span style="color:#a5d6ff">/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">index</span> <span style="color:#a5d6ff">index.html</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">location</span> <span style="color:#a5d6ff">/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">try_files</span> <span style="color:#79c0ff">$uri</span> <span style="color:#a5d6ff">@s3</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">set</span> <span style="color:#79c0ff">$s3_backend</span> <span style="color:#a5d6ff">&#39;https://YOUR_BUCKET_NAME.YOUR_S3_HOSTNAME&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">location</span> <span style="color:#a5d6ff">@s3</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">limit_except</span> <span style="color:#a5d6ff">GET</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff7b72">deny</span> <span style="color:#a5d6ff">all</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">resolver</span> <span style="color:#a5d6ff">8</span><span style="color:#a5d6ff">.8.8.8</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_set_header</span> <span style="color:#a5d6ff">Host</span> <span style="color:#a5d6ff">YOUR_BUCKET_NAME.YOUR_S3_HOSTNAME</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_set_header</span> <span style="color:#a5d6ff">Connection</span> <span style="color:#a5d6ff">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_set_header</span> <span style="color:#a5d6ff">Authorization</span> <span style="color:#a5d6ff">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_hide_header</span> <span style="color:#a5d6ff">Set-Cookie</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_hide_header</span> <span style="color:#a5d6ff">&#39;Access-Control-Allow-Origin&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_hide_header</span> <span style="color:#a5d6ff">&#39;Access-Control-Allow-Methods&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_hide_header</span> <span style="color:#a5d6ff">&#39;Access-Control-Allow-Headers&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_hide_header</span> <span style="color:#a5d6ff">x-amz-id-2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_hide_header</span> <span style="color:#a5d6ff">x-amz-request-id</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_hide_header</span> <span style="color:#a5d6ff">x-amz-meta-server-side-encryption</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_hide_header</span> <span style="color:#a5d6ff">x-amz-server-side-encryption</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_hide_header</span> <span style="color:#a5d6ff">x-amz-bucket-region</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_hide_header</span> <span style="color:#a5d6ff">x-amzn-requestid</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_ignore_headers</span> <span style="color:#a5d6ff">Set-Cookie</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_pass</span> <span style="color:#79c0ff">$s3_backend$uri</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_intercept_errors</span> <span style="color:#79c0ff;font-weight:bold">off</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_cache</span> <span style="color:#a5d6ff">CACHE</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_cache_valid</span> <span style="color:#a5d6ff">200</span> <span style="color:#a5d6ff">48h</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_cache_use_stale</span> <span style="color:#a5d6ff">error</span> <span style="color:#a5d6ff">timeout</span> <span style="color:#a5d6ff">updating</span> <span style="color:#a5d6ff">http_500</span> <span style="color:#a5d6ff">http_502</span> <span style="color:#a5d6ff">http_503</span> <span style="color:#a5d6ff">http_504</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">proxy_cache_lock</span> <span style="color:#79c0ff;font-weight:bold">on</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">expires</span> <span style="color:#a5d6ff">1y</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">add_header</span> <span style="color:#a5d6ff">Cache-Control</span> <span style="color:#a5d6ff">public</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">add_header</span> <span style="color:#a5d6ff">&#39;Access-Control-Allow-Origin&#39;</span> <span style="color:#a5d6ff">&#39;*&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">add_header</span> <span style="color:#a5d6ff">X-Cache-Status</span> <span style="color:#79c0ff">$upstream_cache_status</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">add_header</span> <span style="color:#a5d6ff">X-Content-Type-Options</span> <span style="color:#a5d6ff">nosniff</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">add_header</span> <span style="color:#a5d6ff">Content-Security-Policy</span> <span style="color:#a5d6ff">&#34;default-src</span> <span style="color:#a5d6ff">&#39;none&#39;</span>; <span style="color:#ff7b72">form-action</span> <span style="color:#a5d6ff">&#39;none&#39;&#34;</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="hint hint-info">
  <div class="hint-icon"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M11 17h2v-6h-2zm1-8q.425 0 .713-.288T13 8t-.288-.712T12 7t-.712.288T11 8t.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22"/></svg></div>

  We are using <code>$s3_backend</code> as a variable to force nginx to perform a DNS resolution on its value, as the IP of the object storage provider may not always remain the same.
</div>

<p>This configuration does a few different things:</p>
<ul>
<li>Blocks all but GET requests to the object storage provider</li>
<li>Prevents any authenticated requests to the object storage provider</li>
<li>Prevents the object storage provider from setting cookies</li>
<li>Removes unnecessary headers returned by the object storage provider</li>
<li>Caches valid files for at most 48 hours</li>
<li>Allows older cache to be used if the object storage is unavailable</li>
<li>Uses a cache lock to prevent simultaneous requests to the object storage</li>
<li>Makes all returned files cacheable by browsers for up to a year</li>
<li>Adds CORS headers necessary for Mastodon&rsquo;s web UI</li>
<li>Adds a special header that tells you if your request was a cache hit or miss</li>
</ul>
<p>Make sure to replace:</p>
<ul>
<li><code>files.example.com</code></li>
<li><code>YOUR_BUCKET_NAME</code></li>
<li><code>YOUR_S3_HOSTNAME</code></li>
</ul>
<p>With your actual values. Save your configuration to <code>/etc/nginx/sites-available/files.example.com</code> and then enable it with:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ln -s /etc/nginx/sites-available/files.example.com /etc/nginx/sites-enabled/
</span></span><span style="display:flex;"><span>systemctl reload nginx
</span></span></code></pre></div><p>You&rsquo;ll also want to get an SSL certificate for it:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>certbot --nginx -d files.example.com
</span></span><span style="display:flex;"><span>systemctl reload nginx
</span></span></code></pre></div><p>At last, you&rsquo;ll want to make sure Mastodon is using your new proxy to generate file URLs. Edit your Mastodon&rsquo;s <code>.env.production</code> to add:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#79c0ff">S3_ALIAS_HOST</span><span style="color:#ff7b72;font-weight:bold">=</span>files.example.com
</span></span></code></pre></div><p>And restart Mastodon:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl restart mastodon-sidekiq
</span></span><span style="display:flex;"><span>systemctl reload mastodon-web
</span></span></code></pre></div><div class="hint hint-success">
  <div class="hint-icon"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m10.6 16.6l7.05-7.05l-1.4-1.4l-5.65 5.65l-2.85-2.85l-1.4 1.4zM12 22q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22"/></svg></div>

  <strong>You can now visit your Mastodon in the browser to confirm everything loads correctly</strong>
</div>



    <p style="color: #606085;">
      Last updated December 12, 2023 · <a href='https://github.com/mastodon/documentation/tree/main/content/en/admin%5coptional%5cobject-storage-proxy.md' style="color: #606085;">Improve this page</a>

      
    </p>

  </div>
</main>
  </div>

  <footer class="footer container">
  <div class="sponsorship">
    <div class="container">
      <h2>
        Sponsored by
      </h2>

      <div class="logo-grid">
        <div>
          <a href="https://www.dotcom-monitor.com/es/">
            <img src="/assets/sponsors/dotcom-monitor-logo.png" alt="Dotcom-Monitor" />
          </a>

          <a href="https://www.loadview-testing.com/products/jmeter-load-testing/">
            <img src="/assets/sponsors/LoadView-logo.png" alt="LoadView" />
          </a>

          <a href="http://www.stevetures.com/">
            <img src="/assets/sponsors/stephen-tures.jpg" alt="Stephen Tures" />
          </a>

          <a href="https://swayable.com">
            <img src="/assets/sponsors/swayable.jpeg" alt="Swayable" />
          </a>

          <a href="https://www.sponsormotion.com/">
            <img src="/assets/sponsors/SponsorMotion.png" alt="SponsorMotion" />
          </a>
        </div>
      </div>
    </div>
  </div>

  <p class="legal legal--right">
    <a href='https://joinmastodon.org'>Join Mastodon</a> · <a href='https://blog.joinmastodon.org'>Blog</a> · <a href='https://mastodon.social/@Mastodon' target='_blank'><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mastodon" viewBox="0 0 16 16"><path d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a4 4 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522q0-1.288.66-2.046c.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764q.662.757.661 2.046z"/></svg></a>
  </p>

  <p class="legal"><a href='https://github.com/mastodon/documentation/tree/main/content/en/admin%5coptional%5cobject-storage-proxy.md'>View source</a> · <a href='https://creativecommons.org/licenses/by-sa/4.0/'>CC BY-SA 4.0</a> · <a href='https://joinmastodon.org/imprint'>Imprint</a></p>
</footer>

</body>

</html>
