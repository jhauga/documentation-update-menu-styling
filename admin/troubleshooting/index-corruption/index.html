<!DOCTYPE html>
<html lang="en">

<head>
  

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>

<link rel="shortcut icon" type="image/png" href="/favicon.ico"/>


<link rel='stylesheet' href='/style.min.6f047efea46ea2384fb98ee2d90642926037234cfeb77e270bbd5421bb705db6.css'>


<script src='/main.min.0b774fda2366fc06803dd619b7467da11181c73a4ef394b7610a2eb2a3cb7b5d.js' async></script>


  <title>Database index corruption - Mastodon documentation</title>

  <meta property="og:type" content="article">
  <meta property="og:url" content="https://docs.joinmastodon.org/admin/troubleshooting/index-corruption/">

  
    <meta name="description" content="How to recover from database index corruption.">
    <meta property="og:description" content="How to recover from database index corruption.">
    <meta name="twitter:description" content="How to recover from database index corruption.">
  

  <meta name="twitter:title" content="Database index corruption">
  <meta name="twitter:site" content="@joinmastodon">

  <link rel="canonical" href="https://docs.joinmastodon.org/admin/troubleshooting/index-corruption/">
</head>

<body>
  <div class="container sidebar-layout">
    <nav class="sidebar"><a class="brand" href="/">
  <img class="link-logo" src="/brand.svg" alt="Mastodon" />
</a>

<input id="mobile-nav-toggle" class="mobile-nav-toggle" type="checkbox">
<label for="mobile-nav-toggle">
    <span class="menu-open">
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M6.4 19L5 17.6l5.6-5.6L5 6.4L6.4 5l5.6 5.6L17.6 5L19 6.4L13.4 12l5.6 5.6l-1.4 1.4l-5.6-5.6z"/></svg>
    </span>
    <span class="menu-close">
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M3 18v-2h18v2zm0-5v-2h18v2zm0-5V6h18v2z"/></svg>
    </span>
</label>

<ul>
  
  
    <li>
      
        <a href="/" class="">What is Mastodon?</a>
      

      
    </li>
  
    <li>
      
        <span class="sub-title">Using Mastodon</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/user/signup/" class="">Signing up for an account</a>

              
            </li>
          
            <li>
              <a href="/user/profile/" class="">Setting up your profile</a>

              
            </li>
          
            <li>
              <a href="/user/posting/" class="">Posting to your profile</a>

              
            </li>
          
            <li>
              <a href="/user/network/" class="">Using the network features</a>

              
            </li>
          
            <li>
              <a href="/user/moderating/" class="">Dealing with unwanted content</a>

              
            </li>
          
            <li>
              <a href="/user/discoverability/" class="">Promoting yourself and others</a>

              
            </li>
          
            <li>
              <a href="/user/preferences/" class="">Set your preferences</a>

              
            </li>
          
            <li>
              <a href="/user/contacts/" class="">More settings</a>

              
            </li>
          
            <li>
              <a href="/user/external/" class="">Using Mastodon externally</a>

              
            </li>
          
            <li>
              <a href="/user/moving/" class="">Moving or leaving accounts</a>

              
            </li>
          
            <li>
              <a href="/user/run-your-own/" class="">Running your own server</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">Running Mastodon</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/admin/prerequisites/" class="">Preparing your machine</a>

              
            </li>
          
            <li>
              <a href="/admin/install/" class="">Installing from source</a>

              
            </li>
          
            <li>
              <a href="/admin/config/" class="">Configuring your environment</a>

              
            </li>
          
            <li>
              <a href="/admin/elasticsearch/" class="">Configuring full-text search</a>

              
            </li>
          
            <li>
              <a href="/admin/optional/" class="">Installing optional features</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/admin/optional/object-storage/" class="">Object storage</a>
                    </li>
                  
                    <li>
                      <a href="/admin/optional/tor/" class="">Onion services</a>
                    </li>
                  
                    <li>
                      <a href="/admin/optional/captcha/" class="">Captcha</a>
                    </li>
                  
                    <li>
                      <a href="/admin/optional/sso/" class="">Single Sign On</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/admin/setup/" class="">Setting up your new instance</a>

              
            </li>
          
            <li>
              <a href="/admin/tootctl/" class="">Using the admin CLI</a>

              
            </li>
          
            <li>
              <a href="/admin/upgrading/" class="">Upgrading to a new release</a>

              
            </li>
          
            <li>
              <a href="/admin/backups/" class="">Backing up your server</a>

              
            </li>
          
            <li>
              <a href="/admin/migrating/" class="">Migrating to a new machine</a>

              
            </li>
          
            <li>
              <a href="/admin/scaling/" class="">Scaling up your server</a>

              
            </li>
          
            <li>
              <a href="/admin/moderation/" class="">Moderation actions</a>

              
            </li>
          
            <li>
              <a href="/admin/troubleshooting/" class="">Troubleshooting errors</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/admin/troubleshooting/index-corruption/" class="active">Database index corruption</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/admin/roles/" class="">Roles</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">Developing Mastodon apps</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/client/intro/" class="">Getting started with the API</a>

              
            </li>
          
            <li>
              <a href="/client/public/" class="">Playing with public data</a>

              
            </li>
          
            <li>
              <a href="/client/token/" class="">Obtaining client app access</a>

              
            </li>
          
            <li>
              <a href="/client/authorized/" class="">Logging in with an account</a>

              
            </li>
          
            <li>
              <a href="/client/libraries/" class="">Libraries and implementations</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">Contributing to Mastodon</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/dev/overview/" class="">Technical overview</a>

              
            </li>
          
            <li>
              <a href="/dev/setup/" class="">Setting up a dev environment</a>

              
            </li>
          
            <li>
              <a href="/dev/code/" class="">Code structure</a>

              
            </li>
          
            <li>
              <a href="/dev/routes/" class="">Routes</a>

              
            </li>
          
            <li>
              <a href="/dev/disclosure/" class="">Bug bounties and responsible disclosure</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">Spec compliance</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/spec/activitypub/" class="">ActivityPub</a>

              
            </li>
          
            <li>
              <a href="/spec/webfinger/" class="">WebFinger</a>

              
            </li>
          
            <li>
              <a href="/spec/security/" class="">Security</a>

              
            </li>
          
            <li>
              <a href="/spec/microformats/" class="">Microformats</a>

              
            </li>
          
            <li>
              <a href="/spec/oauth/" class="">OAuth</a>

              
            </li>
          
            <li>
              <a href="/spec/bearcaps/" class="">Bearcaps</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">REST API</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/api/guidelines/" class="">Guidelines and best practices</a>

              
            </li>
          
            <li>
              <a href="/api/oauth-scopes/" class="">OAuth Scopes</a>

              
            </li>
          
            <li>
              <a href="/api/rate-limits/" class="">Rate limits</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">API Methods</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/methods/apps/" class="">apps</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/oauth/" class="">oauth</a>
                    </li>
                  
                    <li>
                      <a href="/methods/emails/" class="">emails</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/accounts/" class="">accounts</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/bookmarks/" class="">bookmarks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/favourites/" class="">favourites</a>
                    </li>
                  
                    <li>
                      <a href="/methods/mutes/" class="">mutes</a>
                    </li>
                  
                    <li>
                      <a href="/methods/blocks/" class="">blocks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/domain_blocks/" class="">domain_blocks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/filters/" class="">filters</a>
                    </li>
                  
                    <li>
                      <a href="/methods/reports/" class="">reports</a>
                    </li>
                  
                    <li>
                      <a href="/methods/follow_requests/" class="">follow_requests</a>
                    </li>
                  
                    <li>
                      <a href="/methods/endorsements/" class="">endorsements</a>
                    </li>
                  
                    <li>
                      <a href="/methods/featured_tags/" class="">featured_tags</a>
                    </li>
                  
                    <li>
                      <a href="/methods/preferences/" class="">preferences</a>
                    </li>
                  
                    <li>
                      <a href="/methods/followed_tags/" class="">followed_tags</a>
                    </li>
                  
                    <li>
                      <a href="/methods/suggestions/" class="">suggestions</a>
                    </li>
                  
                    <li>
                      <a href="/methods/tags/" class="">tags</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/profile/" class="">profile</a>

              
            </li>
          
            <li>
              <a href="/methods/statuses/" class="">statuses</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/media/" class="">media</a>
                    </li>
                  
                    <li>
                      <a href="/methods/polls/" class="">polls</a>
                    </li>
                  
                    <li>
                      <a href="/methods/scheduled_statuses/" class="">scheduled_statuses</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/timelines/" class="">timelines</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/conversations/" class="">conversations</a>
                    </li>
                  
                    <li>
                      <a href="/methods/lists/" class="">lists</a>
                    </li>
                  
                    <li>
                      <a href="/methods/markers/" class="">markers</a>
                    </li>
                  
                    <li>
                      <a href="/methods/streaming/" class="">streaming</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/notifications/" class="">notifications</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/push/" class="">push</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/search/" class="">search</a>

              
            </li>
          
            <li>
              <a href="/methods/instance/" class="">instance</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/trends/" class="">trends</a>
                    </li>
                  
                    <li>
                      <a href="/methods/directory/" class="">directory</a>
                    </li>
                  
                    <li>
                      <a href="/methods/custom_emojis/" class="">custom_emojis</a>
                    </li>
                  
                    <li>
                      <a href="/methods/announcements/" class="">announcements</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/admin/" class="">admin</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/methods/admin/accounts/" class="">accounts</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/canonical_email_blocks/" class="">canonical_email_blocks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/dimensions/" class="">dimensions</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/domain_allows/" class="">domain_allows</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/domain_blocks/" class="">domain_blocks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/email_domain_blocks/" class="">email_domain_blocks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/ip_blocks/" class="">ip_blocks</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/measures/" class="">measures</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/reports/" class="">reports</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/retention/" class="">retention</a>
                    </li>
                  
                    <li>
                      <a href="/methods/admin/trends/" class="">trends</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/methods/proofs/" class="">proofs</a>

              
            </li>
          
            <li>
              <a href="/methods/oembed/" class="">oembed</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">API Entities</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/entities/Account/" class="">Account</a>

              
            </li>
          
            <li>
              <a href="/entities/AccountWarning/" class="">AccountWarning</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_Account/" class="">Admin::Account</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_CanonicalEmailBlock/" class="">Admin::CanonicalEmailBlock</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_Cohort/" class="">Admin::Cohort</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_Dimension/" class="">Admin::Dimension</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_DomainAllow/" class="">Admin::DomainAllow</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_DomainBlock/" class="">Admin::DomainBlock</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_EmailDomainBlock/" class="">Admin::EmailDomainBlock</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_Ip/" class="">Admin::Ip</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_IpBlock/" class="">Admin::IpBlock</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_Measure/" class="">Admin::Measure</a>

              
            </li>
          
            <li>
              <a href="/entities/Admin_Report/" class="">Admin::Report</a>

              
            </li>
          
            <li>
              <a href="/entities/Announcement/" class="">Announcement</a>

              
            </li>
          
            <li>
              <a href="/entities/Appeal/" class="">Appeal</a>

              
            </li>
          
            <li>
              <a href="/entities/Application/" class="">Application</a>

              
            </li>
          
            <li>
              <a href="/entities/Context/" class="">Context</a>

              
            </li>
          
            <li>
              <a href="/entities/Conversation/" class="">Conversation</a>

              
            </li>
          
            <li>
              <a href="/entities/CustomEmoji/" class="">CustomEmoji</a>

              
            </li>
          
            <li>
              <a href="/entities/DomainBlock/" class="">DomainBlock</a>

              
            </li>
          
            <li>
              <a href="/entities/Error/" class="">Error</a>

              
            </li>
          
            <li>
              <a href="/entities/ExtendedDescription/" class="">ExtendedDescription</a>

              
            </li>
          
            <li>
              <a href="/entities/FamiliarFollowers/" class="">FamiliarFollowers</a>

              
            </li>
          
            <li>
              <a href="/entities/FeaturedTag/" class="">FeaturedTag</a>

              
            </li>
          
            <li>
              <a href="/entities/Filter/" class="">Filter</a>

              
            </li>
          
            <li>
              <a href="/entities/FilterKeyword/" class="">FilterKeyword</a>

              
            </li>
          
            <li>
              <a href="/entities/FilterResult/" class="">FilterResult</a>

              
            </li>
          
            <li>
              <a href="/entities/FilterStatus/" class="">FilterStatus</a>

              
            </li>
          
            <li>
              <a href="/entities/IdentityProof/" class="">IdentityProof</a>

              
            </li>
          
            <li>
              <a href="/entities/Instance/" class="">Instance</a>

              
            </li>
          
            <li>
              <a href="/entities/List/" class="">List</a>

              
            </li>
          
            <li>
              <a href="/entities/Marker/" class="">Marker</a>

              
            </li>
          
            <li>
              <a href="/entities/MediaAttachment/" class="">MediaAttachment</a>

              
            </li>
          
            <li>
              <a href="/entities/Notification/" class="">Notification</a>

              
            </li>
          
            <li>
              <a href="/entities/NotificationPolicy/" class="">NotificationPolicy</a>

              
            </li>
          
            <li>
              <a href="/entities/NotificationRequest/" class="">NotificationRequest</a>

              
            </li>
          
            <li>
              <a href="/entities/Poll/" class="">Poll</a>

              
            </li>
          
            <li>
              <a href="/entities/Preferences/" class="">Preferences</a>

              
            </li>
          
            <li>
              <a href="/entities/PreviewCard/" class="">PreviewCard</a>

              
            </li>
          
            <li>
              <a href="/entities/PreviewCardAuthor/" class="">PreviewCardAuthor</a>

              
            </li>
          
            <li>
              <a href="/entities/Reaction/" class="">Reaction</a>

              
            </li>
          
            <li>
              <a href="/entities/Relationship/" class="">Relationship</a>

              
            </li>
          
            <li>
              <a href="/entities/RelationshipSeveranceEvent/" class="">RelationshipSeveranceEvent</a>

              
            </li>
          
            <li>
              <a href="/entities/Report/" class="">Report</a>

              
            </li>
          
            <li>
              <a href="/entities/Role/" class="">Role</a>

              
            </li>
          
            <li>
              <a href="/entities/Rule/" class="">Rule</a>

              
            </li>
          
            <li>
              <a href="/entities/ScheduledStatus/" class="">ScheduledStatus</a>

              
            </li>
          
            <li>
              <a href="/entities/Search/" class="">Search</a>

              
            </li>
          
            <li>
              <a href="/entities/Status/" class="">Status</a>

              
            </li>
          
            <li>
              <a href="/entities/StatusEdit/" class="">StatusEdit</a>

              
            </li>
          
            <li>
              <a href="/entities/StatusSource/" class="">StatusSource</a>

              
            </li>
          
            <li>
              <a href="/entities/Suggestion/" class="">Suggestion</a>

              
            </li>
          
            <li>
              <a href="/entities/Tag/" class="">Tag</a>

              
            </li>
          
            <li>
              <a href="/entities/Token/" class="">Token</a>

              
            </li>
          
            <li>
              <a href="/entities/Translation/" class="">Translation</a>

              
            </li>
          
            <li>
              <a href="/entities/V1_Filter/" class="">V1::Filter</a>

              
            </li>
          
            <li>
              <a href="/entities/V1_Instance/" class="">V1::Instance</a>

              
            </li>
          
            <li>
              <a href="/entities/V1_NotificationPolicy/" class="">V1::NotificationPolicy</a>

              
            </li>
          
            <li>
              <a href="/entities/WebPushSubscription/" class="">WebPushSubscription</a>

              
            </li>
          
        </ul>
      
    </li>
  
</ul>
</nav>
    <main>
  <h1>Database index corruption</h1>

  
    <p>How to recover from database index corruption.</p>
  
  <aside>
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#explanation">Locale data and collation</a></li>
        <li><a href="#am-i-affected">Am I affected by this issue?</a></li>
        <li><a href="#fixing">Fixing the issue</a></li>
        <li><a href="#avoiding-the-issue">Avoiding the issue</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </aside>
  <div class="e-content">
    <p>A somewhat common configuration issue can lead to index corruption throughout the database. This page attempts to explain why this may occur and how to fix it.</p>
<h2 class="heading" id="explanation">
	<span class="heading__text">Locale data and collation</span>
	<a class="heading__anchor-link" href="#explanation">
		<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M10.59 13.41c.41.39.41 1.03 0 1.42c-.39.39-1.03.39-1.42 0a5.003 5.003 0 0 1 0-7.07l3.54-3.54a5.003 5.003 0 0 1 7.07 0a5.003 5.003 0 0 1 0 7.07l-1.49 1.49c.01-.82-.12-1.64-.4-2.42l.47-.48a2.98 2.98 0 0 0 0-4.24a2.98 2.98 0 0 0-4.24 0l-3.53 3.53a2.98 2.98 0 0 0 0 4.24m2.82-4.24c.39-.39 1.03-.39 1.42 0a5.003 5.003 0 0 1 0 7.07l-3.54 3.54a5.003 5.003 0 0 1-7.07 0a5.003 5.003 0 0 1 0-7.07l1.49-1.49c-.01.82.12 1.64.4 2.43l-.47.47a2.98 2.98 0 0 0 0 4.24a2.98 2.98 0 0 0 4.24 0l3.53-3.53a2.98 2.98 0 0 0 0-4.24a.973.973 0 0 1 0-1.42"/></svg>
	</a>
</h2><p>Textual values in the database, such as usernames, or status identifiers, are compared using so-called collation rules defining how characters are ordered and how to change their case.
When setting up a database, Mastodon will use the database server&rsquo;s default locale settings, including the default collation rules, which often is defined by the operating system&rsquo;s settings.</p>
<p>Unfortunately, in late 2018, a <code>glibc</code> update changed the collation rules for many locales, which means databases using an affected locale would now order textual values differently.
Since the database indexes are algorithmic structures that rely on the ordering of the values they are indexing, some of them would become inconsistent.</p>
<p>More information: <a href="https://wiki.postgresql.org/wiki/Locale_data_changes">https://wiki.postgresql.org/wiki/Locale_data_changes</a> <a href="https://postgresql.verite.pro/blog/2018/08/27/glibc-upgrade.html">https://postgresql.verite.pro/blog/2018/08/27/glibc-upgrade.html</a></p>
<h2 class="heading" id="am-i-affected">
	<span class="heading__text">Am I affected by this issue?</span>
	<a class="heading__anchor-link" href="#am-i-affected">
		<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M10.59 13.41c.41.39.41 1.03 0 1.42c-.39.39-1.03.39-1.42 0a5.003 5.003 0 0 1 0-7.07l3.54-3.54a5.003 5.003 0 0 1 7.07 0a5.003 5.003 0 0 1 0 7.07l-1.49 1.49c.01-.82-.12-1.64-.4-2.42l.47-.48a2.98 2.98 0 0 0 0-4.24a2.98 2.98 0 0 0-4.24 0l-3.53 3.53a2.98 2.98 0 0 0 0 4.24m2.82-4.24c.39-.39 1.03-.39 1.42 0a5.003 5.003 0 0 1 0 7.07l-3.54 3.54a5.003 5.003 0 0 1-7.07 0a5.003 5.003 0 0 1 0-7.07l1.49-1.49c-.01.82.12 1.64.4 2.43l-.47.47a2.98 2.98 0 0 0 0 4.24a2.98 2.98 0 0 0 4.24 0l3.53-3.53a2.98 2.98 0 0 0 0-4.24a.973.973 0 0 1 0-1.42"/></svg>
	</a>
</h2><p>If your database is not using <code>C</code> or <code>POSIX</code> for its collation setting (which you can check with <code>SELECT datcollate FROM pg_database WHERE datname = current_database();</code>),
your indexes might be inconsistent if you ever ran with a version of glibc prior to 2.28 and did not immediately reindex your databases after updating to glibc 2.28 or newer.</p>
<div class="hint hint-info">
  <div class="hint-icon"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M11 17h2v-6h-2zm1-8q.425 0 .713-.288T13 8t-.288-.712T12 7t-.712.288T11 8t.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22"/></svg></div>

  You may have found this page because of PgHero warnings about &ldquo;Duplicate Indexes&rdquo;. While such warnings can sometimes be indicative of an issue in deploying or updating Mastodon, <strong>they are not related to database index corruption and are not indicative of any functional issue with your database</strong>.
</div>

<p>You can check whether your indexes are consistent using <a href="https://www.postgresql.org/docs/10/amcheck.html">PostgreSQL&rsquo;s <code>amcheck</code> module</a>: as the database server&rsquo;s super user, connect to your Mastodon database and issue the following (this may take a while):</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-SQL" data-lang="SQL"><span style="display:flex;"><span><span style="color:#ff7b72">CREATE</span><span style="color:#6e7681"> </span>EXTENSION<span style="color:#6e7681"> </span><span style="color:#ff7b72">IF</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">NOT</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">EXISTS</span><span style="color:#6e7681"> </span>amcheck;<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">SELECT</span><span style="color:#6e7681"> </span>bt_index_check(<span style="color:#ff7b72">c</span>.oid)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">FROM</span><span style="color:#6e7681"> </span>pg_index<span style="color:#6e7681"> </span>i<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">JOIN</span><span style="color:#6e7681"> </span>pg_class<span style="color:#6e7681"> </span><span style="color:#ff7b72">c</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">ON</span><span style="color:#6e7681"> </span>i.indexrelid<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">c</span>.oid<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">WHERE</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">c</span>.relname<span style="color:#6e7681"> </span><span style="color:#ff7b72">IN</span><span style="color:#6e7681"> </span>(<span style="color:#a5d6ff">&#39;index_account_domain_blocks_on_account_id_and_domain&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_account_proofs_on_account_and_provider_and_username&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_accounts_on_username_and_domain_lower&#39;</span>,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#39;index_accounts_on_uri&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_accounts_on_url&#39;</span>,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#39;index_conversations_on_uri&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_custom_emoji_categories_on_name&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_custom_emojis_on_shortcode_and_domain&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_devices_on_access_token_id&#39;</span>,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#39;index_domain_allows_on_domain&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_domain_blocks_on_domain&#39;</span>,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#39;index_email_domain_blocks_on_domain&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_invites_on_code&#39;</span>,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#39;index_markers_on_user_id_and_timeline&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_media_attachments_on_shortcode&#39;</span>,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#39;index_preview_cards_on_url&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_statuses_on_uri&#39;</span>,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#39;index_tags_on_name_lower&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_tombstones_on_uri&#39;</span>,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#39;index_unavailable_domains_on_domain&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_users_on_email&#39;</span>,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#39;index_webauthn_credentials_on_external_id&#39;</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>);<span style="color:#6e7681">
</span></span></span></code></pre></div><p>If this raises an error, your database is corrupted and needs fixing. If it does not, you may need to perform more involved checks to be sure.
Unlike the previous checks, those more involved checks will lock tables when running, thus interfering with the availability of your instance.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-SQL" data-lang="SQL"><span style="display:flex;"><span><span style="color:#ff7b72">CREATE</span><span style="color:#6e7681"> </span>EXTENSION<span style="color:#6e7681"> </span><span style="color:#ff7b72">IF</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">NOT</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">EXISTS</span><span style="color:#6e7681"> </span>amcheck;<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">SELECT</span><span style="color:#6e7681"> </span>bt_index_parent_check(<span style="color:#ff7b72">c</span>.oid)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">FROM</span><span style="color:#6e7681"> </span>pg_index<span style="color:#6e7681"> </span>i<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">JOIN</span><span style="color:#6e7681"> </span>pg_class<span style="color:#6e7681"> </span><span style="color:#ff7b72">c</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">ON</span><span style="color:#6e7681"> </span>i.indexrelid<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">c</span>.oid<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">WHERE</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">c</span>.relname<span style="color:#6e7681"> </span><span style="color:#ff7b72">IN</span><span style="color:#6e7681"> </span>(<span style="color:#a5d6ff">&#39;index_account_domain_blocks_on_account_id_and_domain&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_account_proofs_on_account_and_provider_and_username&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_accounts_on_username_and_domain_lower&#39;</span>,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#39;index_accounts_on_uri&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_accounts_on_url&#39;</span>,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#39;index_conversations_on_uri&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_custom_emoji_categories_on_name&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_custom_emojis_on_shortcode_and_domain&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_devices_on_access_token_id&#39;</span>,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#39;index_domain_allows_on_domain&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_domain_blocks_on_domain&#39;</span>,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#39;index_email_domain_blocks_on_domain&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_invites_on_code&#39;</span>,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#39;index_markers_on_user_id_and_timeline&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_media_attachments_on_shortcode&#39;</span>,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#39;index_preview_cards_on_url&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_statuses_on_uri&#39;</span>,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#39;index_tags_on_name_lower&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_tombstones_on_uri&#39;</span>,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#39;index_unavailable_domains_on_domain&#39;</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">  </span><span style="color:#a5d6ff">&#39;index_users_on_email&#39;</span>,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#39;index_webauthn_credentials_on_external_id&#39;</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>);<span style="color:#6e7681">
</span></span></span></code></pre></div><p>If this succeeds, without returning an error, your database should be consistent, and you can safely disregard the warning Mastodon emits when running <code>db:migrate</code>.</p>
<h2 class="heading" id="fixing">
	<span class="heading__text">Fixing the issue</span>
	<a class="heading__anchor-link" href="#fixing">
		<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M10.59 13.41c.41.39.41 1.03 0 1.42c-.39.39-1.03.39-1.42 0a5.003 5.003 0 0 1 0-7.07l3.54-3.54a5.003 5.003 0 0 1 7.07 0a5.003 5.003 0 0 1 0 7.07l-1.49 1.49c.01-.82-.12-1.64-.4-2.42l.47-.48a2.98 2.98 0 0 0 0-4.24a2.98 2.98 0 0 0-4.24 0l-3.53 3.53a2.98 2.98 0 0 0 0 4.24m2.82-4.24c.39-.39 1.03-.39 1.42 0a5.003 5.003 0 0 1 0 7.07l-3.54 3.54a5.003 5.003 0 0 1-7.07 0a5.003 5.003 0 0 1 0-7.07l1.49-1.49c-.01.82.12 1.64.4 2.43l-.47.47a2.98 2.98 0 0 0 0 4.24a2.98 2.98 0 0 0 4.24 0l3.53-3.53a2.98 2.98 0 0 0 0-4.24a.973.973 0 0 1 0-1.42"/></svg>
	</a>
</h2><p>Unless you take action, if you are affected, your database could get more and more inconsistent as time passes. Therefore, it is important to fix it as soon as possible.</p>
<p>Mastodon 3.2.2 and later come with a semi-interactive script to fix those corruptions as best as possible. If you&rsquo;re on an earlier version, update to 3.2.2 first. It is possible that running the database migrations to 3.2.2 will fail because of those very corruptions, but the database should then be brought to a state that the maintenance tool bundled with Mastodon 3.2.2 can then recover from.</p>
<p>Before attempting to fix your database, <strong>stop Mastodon and make a backup of your database</strong>. Then, with <strong>Mastodon still stopped</strong>, run the maintenance script:</p>
<pre tabindex="0"><code>RAILS_ENV=production bin/tootctl maintenance fix-duplicates
</code></pre><p>The script will walk through the database to automatically find duplicates and fix them. In some cases, those operations are destructive. In the most destructive cases, you will be asked to choose which record to keep and which records to discard. In all cases, walking through the whole database in search of duplicates is an extremely long operation.</p>
<div class="hint hint-warning">
  <div class="hint-icon"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M1 21L12 2l11 19zm11-3q.425 0 .713-.288T13 17t-.288-.712T12 16t-.712.288T11 17t.288.713T12 18m-1-3h2v-5h-2z"/></svg></div>

  In some cases, duplicate records may have unreconcilable conflicts (such as two different local users sharing the same username). In these cases, the deduplication operation may be <strong>partially destructive</strong> and you will be asked which records to keep unchanged and which records will be changed.
This script is therefore semi-interactive. In all cases, walking through the whole database in search of duplicates is an extremely long operation.
</div>

<div class="hint hint-danger">
  <div class="hint-icon"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M12 17q.425 0 .713-.288T13 16t-.288-.712T12 15t-.712.288T11 16t.288.713T12 17m-1-4h2V7h-2zm1 10.3L8.65 20H4v-4.65L.7 12L4 8.65V4h4.65L12 .7L15.35 4H20v4.65L23.3 12L20 15.35V20h-4.65z"/></svg></div>

  <strong>Because the maintenance script will temporarily remove indexes, Mastodon has to be completely stopped during the whole process to prevent additional duplicates from occurring.</strong>
</div>

<h2 class="heading" id="avoiding-the-issue">
	<span class="heading__text">Avoiding the issue</span>
	<a class="heading__anchor-link" href="#avoiding-the-issue">
		<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M10.59 13.41c.41.39.41 1.03 0 1.42c-.39.39-1.03.39-1.42 0a5.003 5.003 0 0 1 0-7.07l3.54-3.54a5.003 5.003 0 0 1 7.07 0a5.003 5.003 0 0 1 0 7.07l-1.49 1.49c.01-.82-.12-1.64-.4-2.42l.47-.48a2.98 2.98 0 0 0 0-4.24a2.98 2.98 0 0 0-4.24 0l-3.53 3.53a2.98 2.98 0 0 0 0 4.24m2.82-4.24c.39-.39 1.03-.39 1.42 0a5.003 5.003 0 0 1 0 7.07l-3.54 3.54a5.003 5.003 0 0 1-7.07 0a5.003 5.003 0 0 1 0-7.07l1.49-1.49c-.01.82.12 1.64.4 2.43l-.47.47a2.98 2.98 0 0 0 0 4.24a2.98 2.98 0 0 0 4.24 0l3.53-3.53a2.98 2.98 0 0 0 0-4.24a.973.973 0 0 1 0-1.42"/></svg>
	</a>
</h2><p>To avoid the issue, reindex your database immediately after any libc update.
The
<a href="https://www.postgresql.org/docs/current/sql-reindex.html">SQL command <code>REINDEX</code></a>
or the
<a href="https://www.postgresql.org/docs/current/app-reindexdb.html"><code>reindexdb</code> command-line tool</a>
may be useful for this.</p>


    <p style="color: #606085;">
      Last updated December 8, 2023 · <a href='https://github.com/mastodon/documentation/tree/main/content/en/admin%5ctroubleshooting%5cindex-corruption.md' style="color: #606085;">Improve this page</a>

      
    </p>

  </div>
</main>
  </div>

  <footer class="footer container">
  <div class="sponsorship">
    <div class="container">
      <h2>
        Sponsored by
      </h2>

      <div class="logo-grid">
        <div>
          <a href="https://www.dotcom-monitor.com/es/">
            <img src="/assets/sponsors/dotcom-monitor-logo.png" alt="Dotcom-Monitor" />
          </a>

          <a href="https://www.loadview-testing.com/products/jmeter-load-testing/">
            <img src="/assets/sponsors/LoadView-logo.png" alt="LoadView" />
          </a>

          <a href="http://www.stevetures.com/">
            <img src="/assets/sponsors/stephen-tures.jpg" alt="Stephen Tures" />
          </a>

          <a href="https://swayable.com">
            <img src="/assets/sponsors/swayable.jpeg" alt="Swayable" />
          </a>

          <a href="https://www.sponsormotion.com/">
            <img src="/assets/sponsors/SponsorMotion.png" alt="SponsorMotion" />
          </a>
        </div>
      </div>
    </div>
  </div>

  <p class="legal legal--right">
    <a href='https://joinmastodon.org'>Join Mastodon</a> · <a href='https://blog.joinmastodon.org'>Blog</a> · <a href='https://mastodon.social/@Mastodon' target='_blank'><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mastodon" viewBox="0 0 16 16"><path d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a4 4 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522q0-1.288.66-2.046c.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764q.662.757.661 2.046z"/></svg></a>
  </p>

  <p class="legal"><a href='https://github.com/mastodon/documentation/tree/main/content/en/admin%5ctroubleshooting%5cindex-corruption.md'>View source</a> · <a href='https://creativecommons.org/licenses/by-sa/4.0/'>CC BY-SA 4.0</a> · <a href='https://joinmastodon.org/imprint'>Imprint</a></p>
</footer>

</body>

</html>
